version: '3.8'

services:
  snapserver:
    image: ${DOCKER_USERNAME}/plum-snapcast-server:${TAG:-latest}
    container_name: plum-snapcast-server
    restart: always
    network_mode: host  # Required for AirPlay mDNS discovery
    privileged: true    # Simplest way to ensure audio access
    environment:
      TZ: "${TZ:-America/New_York}"
      
      # AirPlay Configuration
      AIRPLAY_CONFIG_ENABLED: "1"
      AIRPLAY_DEVICE_NAME: "${AIRPLAY_DEVICE_NAME:-Plum Audio}"
      
      # Snapclient Configuration (integrated audio output)
      SNAPCLIENT_ENABLED: "1"
      SNAPCLIENT_HOST: "localhost"
      SNAPCLIENT_SOUNDCARD: "plughw:1,0"  # RPi 4 headphone jack
      SNAPCLIENT_LATENCY: "0"
      
      # HTTPS Configuration
      HTTPS_ENABLED: "${HTTPS_ENABLED:-1}"
      SKIP_CERT_GENERATION: "${SKIP_CERT_GENERATION:-0}"
      
      # Optional: Spotify (disabled by default)
      SPOTIFY_CONFIG_ENABLED: "${SPOTIFY_CONFIG_ENABLED:-0}"
      SPOTIFY_DEVICE_NAME: "${SPOTIFY_DEVICE_NAME:-Plum Audio}"
      SPOTIFY_BITRATE: "320"
      SPOTIFY_ACCESS_TOKEN: "${SPOTIFY_ACCESS_TOKEN:-}"
      
      # Disable unnecessary features
      PIPE_CONFIG_ENABLED: "0"
      META_CONFIG_ENABLED: "0"
    volumes:
      - snapcast-data:/app/data/
      - snapcast-config:/app/config/
      - snapcast-certs:/app/certs/
      - /tmp:/tmp  # Share /tmp for FIFO pipes
    devices:
      - /dev/snd:/dev/snd  # Audio device access

  frontend:
    image: ${DOCKER_USERNAME}/plum-snapcast-frontend:${TAG:-latest}
    container_name: plum-snapcast-frontend
    restart: always
    ports:
      - "3000:80"
    depends_on:
      - snapserver

volumes:
  snapcast-data:
  snapcast-config:
  snapcast-certs: