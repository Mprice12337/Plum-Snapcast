# D-Bus system bus - runs as root initially, then drops to messagebus
[program:dbus]
command=/bin/sh -c "rm -f /var/run/dbus/pid && /usr/bin/dbus-daemon --system --nofork --nopidfile"
priority=1
autostart=true
autorestart=true
startsecs=5
startretries=3
stdout_logfile=/var/log/supervisord/dbus.log
stdout_logfile_maxbytes=10MB
stderr_logfile=/var/log/supervisord/dbus_err.log
stderr_logfile_maxbytes=10MB

# Avahi daemon - runs as avahi user, with D-Bus enabled for shairport-sync
[program:avahi]
command=/usr/sbin/avahi-daemon --no-chroot --no-drop-root
user=avahi
priority=10
autostart=true
autorestart=true
startsecs=5
startretries=3
stdout_logfile=/var/log/supervisord/avahi.log
stdout_logfile_maxbytes=10MB
stderr_logfile=/var/log/supervisord/avahi_err.log
stderr_logfile_maxbytes=10MB

# Snapserver - runs as snapcast user
[program:snapserver]
command=/usr/bin/snapserver -c /app/config/snapserver.conf
user=snapcast
directory=/app
priority=30
autostart=true
autorestart=true
startsecs=5
startretries=3
stdout_logfile=/var/log/supervisord/snapserver.log
stdout_logfile_maxbytes=50MB
stderr_logfile=/var/log/supervisord/snapserver_err.log
stderr_logfile_maxbytes=10MB

# Shairport-sync - runs as snapcast user
# FIXED: Added 5-second delay to ensure avahi is fully initialized
[program:shairport-sync]
command=/bin/sh -c "sleep 5 && /usr/local/bin/shairport-sync --configfile=/app/config/shairport-sync.conf"
user=snapcast
directory=/app
environment=HOME="/app"
priority=40
autostart=true
autorestart=unexpected
startsecs=15
startretries=3
stdout_logfile=/var/log/supervisord/shairport.log
stdout_logfile_maxbytes=50MB
stderr_logfile=/var/log/supervisord/shairport_err.log
stderr_logfile_maxbytes=10MB