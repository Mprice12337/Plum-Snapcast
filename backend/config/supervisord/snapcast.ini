# D-Bus and Avahi provided by HOST system via volume mounts
# Container uses host's /var/run/dbus and /var/run/avahi-daemon
# These services must be running on the host:
#   systemctl start dbus.socket
#   systemctl start avahi-daemon

# D-Bus disabled - using host service
#[program:dbus]
#command=/bin/sh -c "rm -f /var/run/dbus/pid /var/run/dbus/system_bus_socket && mkdir -p /var/run/dbus && /usr/bin/dbus-daemon --system --nofork --nopidfile"
#user=root
#priority=1
#autostart=true
#autorestart=true
#startsecs=5
#startretries=3
#stdout_logfile=/var/log/supervisord/dbus.log
#stdout_logfile_maxbytes=10MB
#stderr_logfile=/var/log/supervisord/dbus_err.log
#stderr_logfile_maxbytes=10MB

# Avahi disabled - using host service
#[program:avahi]
#command=/bin/sh -c "rm -rf /var/run/avahi-daemon/* && /usr/sbin/avahi-daemon --no-chroot --no-drop-root"
#user=root
#priority=10
#autostart=true
#autorestart=true
#startsecs=10
#startretries=3
#stdout_logfile=/var/log/supervisord/avahi.log
#stdout_logfile_maxbytes=10MB
#stderr_logfile=/var/log/supervisord/avahi_err.log
#stderr_logfile_maxbytes=10MB

# Snapserver
[program:snapserver]
command=/usr/bin/snapserver -c /app/config/snapserver.conf
user=snapcast
directory=/app
priority=30
autostart=true
autorestart=true
startsecs=5
startretries=3
stdout_logfile=/var/log/supervisord/snapserver.log
stdout_logfile_maxbytes=50MB
stderr_logfile=/var/log/supervisord/snapserver_err.log
stderr_logfile_maxbytes=10MB

# Shairport-sync - wait for Avahi to be ready
[program:shairport-sync]
command=/bin/sh -c "sleep 15 && /usr/local/bin/shairport-sync --configfile=/app/config/shairport-sync.conf"
user=root
directory=/app
environment=HOME="/app"
priority=40
autostart=true
autorestart=true
startsecs=25
startretries=3
stopasgroup=true
killasgroup=true
stdout_logfile=/var/log/supervisord/shairport.log
stdout_logfile_maxbytes=50MB
stderr_logfile=/var/log/supervisord/shairport_err.log
stderr_logfile_maxbytes=10MB